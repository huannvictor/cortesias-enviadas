import os
from collections import defaultdict
import pandas as pd

DIRECTORY = r'C:\Digitalizacao_Cortesias\Processadas'
SPREADSHEET_PATH = r'C:\Digitalizacao_Cortesias\cortesias_enviadas.xlsx'

def list_files(dir_path):
    files = []
    for file in os.listdir(dir_path):
        if os.path.isfile(os.path.join(dir_path, file)):
            files.append(file)
    return files

def process_files(files):
    school_data = defaultdict(lambda: { "year": 2025, "pages": set()})
    for file in files:
        file_name = file.split('.')[0]
        file_parts = file_name.split('_')

        if len(file_parts) == 3:
            school_code, year, page = file_parts
            try:
                school_code = int(school_code)
            except ValueError:
                print(f'Código da escola inválido (não é um número): {school_code}')
                continue
            if year == '2025':
                school_data[school_code]["pages"].add(page)

    for school_code, info in school_data.items():
        info['pages'] = len(info['pages'])

    return school_data

def save_to_spreadsheet(school_data, output_path):
    data = []
    for school_code, info in school_data.items():
        data.append([int(school_code), info['year'], info['pages']])
    df = pd.DataFrame(data, columns=["school_code", "year", "pages"])
    df.to_excel(output_path, index=False)

files_array = list_files(DIRECTORY)
schools = process_files(files_array)
save_to_spreadsheet(schools, SPREADSHEET_PATH)

print(f'relatório gerado em {SPREADSHEET_PATH}')
